{"ast":null,"code":"var __awaiter = this && this.__awaiter || function (thisArg, _arguments, P, generator) {\n  function adopt(value) {\n    return value instanceof P ? value : new P(function (resolve) {\n      resolve(value);\n    });\n  }\n  return new (P || (P = Promise))(function (resolve, reject) {\n    function fulfilled(value) {\n      try {\n        step(generator.next(value));\n      } catch (e) {\n        reject(e);\n      }\n    }\n    function rejected(value) {\n      try {\n        step(generator[\"throw\"](value));\n      } catch (e) {\n        reject(e);\n      }\n    }\n    function step(result) {\n      result.done ? resolve(result.value) : adopt(result.value).then(fulfilled, rejected);\n    }\n    step((generator = generator.apply(thisArg, _arguments || [])).next());\n  });\n};\nvar __generator = this && this.__generator || function (thisArg, body) {\n  var _ = {\n      label: 0,\n      sent: function () {\n        if (t[0] & 1) throw t[1];\n        return t[1];\n      },\n      trys: [],\n      ops: []\n    },\n    f,\n    y,\n    t,\n    g;\n  return g = {\n    next: verb(0),\n    \"throw\": verb(1),\n    \"return\": verb(2)\n  }, typeof Symbol === \"function\" && (g[Symbol.iterator] = function () {\n    return this;\n  }), g;\n  function verb(n) {\n    return function (v) {\n      return step([n, v]);\n    };\n  }\n  function step(op) {\n    if (f) throw new TypeError(\"Generator is already executing.\");\n    while (_) try {\n      if (f = 1, y && (t = op[0] & 2 ? y[\"return\"] : op[0] ? y[\"throw\"] || ((t = y[\"return\"]) && t.call(y), 0) : y.next) && !(t = t.call(y, op[1])).done) return t;\n      if (y = 0, t) op = [op[0] & 2, t.value];\n      switch (op[0]) {\n        case 0:\n        case 1:\n          t = op;\n          break;\n        case 4:\n          _.label++;\n          return {\n            value: op[1],\n            done: false\n          };\n        case 5:\n          _.label++;\n          y = op[1];\n          op = [0];\n          continue;\n        case 7:\n          op = _.ops.pop();\n          _.trys.pop();\n          continue;\n        default:\n          if (!(t = _.trys, t = t.length > 0 && t[t.length - 1]) && (op[0] === 6 || op[0] === 2)) {\n            _ = 0;\n            continue;\n          }\n          if (op[0] === 3 && (!t || op[1] > t[0] && op[1] < t[3])) {\n            _.label = op[1];\n            break;\n          }\n          if (op[0] === 6 && _.label < t[1]) {\n            _.label = t[1];\n            t = op;\n            break;\n          }\n          if (t && _.label < t[2]) {\n            _.label = t[2];\n            _.ops.push(op);\n            break;\n          }\n          if (t[2]) _.ops.pop();\n          _.trys.pop();\n          continue;\n      }\n      op = body.call(thisArg, _);\n    } catch (e) {\n      op = [6, e];\n      y = 0;\n    } finally {\n      f = t = 0;\n    }\n    if (op[0] & 5) throw op[1];\n    return {\n      value: op[0] ? op[1] : void 0,\n      done: true\n    };\n  }\n};\nvar __read = this && this.__read || function (o, n) {\n  var m = typeof Symbol === \"function\" && o[Symbol.iterator];\n  if (!m) return o;\n  var i = m.call(o),\n    r,\n    ar = [],\n    e;\n  try {\n    while ((n === void 0 || n-- > 0) && !(r = i.next()).done) ar.push(r.value);\n  } catch (error) {\n    e = {\n      error: error\n    };\n  } finally {\n    try {\n      if (r && !r.done && (m = i[\"return\"])) m.call(i);\n    } finally {\n      if (e) throw e.error;\n    }\n  }\n  return ar;\n};\nvar __spread = this && this.__spread || function () {\n  for (var ar = [], i = 0; i < arguments.length; i++) ar = ar.concat(__read(arguments[i]));\n  return ar;\n};\nimport Auth from '@aws-amplify/auth';\nimport { GRAPHQL_AUTH_MODE } from '@aws-amplify/api-graphql';\nimport { ModelAttributeAuthProvider } from '../types';\nfunction getProviderFromRule(rule) {\n  // private with no provider means userPools\n  if (rule.allow === 'private' && !rule.provider) {\n    return ModelAttributeAuthProvider.USER_POOLS;\n  }\n  // public with no provider means apiKey\n  if (rule.allow === 'public' && !rule.provider) {\n    return ModelAttributeAuthProvider.API_KEY;\n  }\n  return rule.provider;\n}\nfunction sortAuthRulesWithPriority(rules) {\n  var allowSortPriority = ['owner', 'groups', 'private', 'public'];\n  var providerSortPriority = ['userPools', 'oidc', 'iam', 'apiKey'];\n  return __spread(rules).sort(function (a, b) {\n    if (a.allow === b.allow) {\n      return providerSortPriority.indexOf(getProviderFromRule(a)) - providerSortPriority.indexOf(getProviderFromRule(b));\n    }\n    return allowSortPriority.indexOf(a.allow) - allowSortPriority.indexOf(b.allow);\n  });\n}\nfunction getAuthRules(_a) {\n  var rules = _a.rules,\n    currentUser = _a.currentUser;\n  // Using Set to ensure uniqueness\n  var authModes = new Set();\n  rules.forEach(function (rule) {\n    switch (rule.allow) {\n      case 'groups':\n      case 'owner':\n        {\n          // We shouldn't attempt User Pool or OIDC if there isn't an authenticated user\n          if (currentUser) {\n            if (rule.provider === 'userPools') {\n              authModes.add(GRAPHQL_AUTH_MODE.AMAZON_COGNITO_USER_POOLS);\n            } else if (rule.provider === 'oidc') {\n              authModes.add(GRAPHQL_AUTH_MODE.OPENID_CONNECT);\n            }\n          }\n          break;\n        }\n      case 'private':\n        {\n          // We shouldn't attempt private if there isn't an authenticated user\n          if (currentUser) {\n            // private with no provider means userPools\n            if (!rule.provider || rule.provider === 'userPools') {\n              authModes.add(GRAPHQL_AUTH_MODE.AMAZON_COGNITO_USER_POOLS);\n            } else if (rule.provider === 'iam') {\n              authModes.add(GRAPHQL_AUTH_MODE.AWS_IAM);\n            }\n          }\n          break;\n        }\n      case 'public':\n        {\n          if (rule.provider === 'iam') {\n            authModes.add(GRAPHQL_AUTH_MODE.AWS_IAM);\n          } else if (!rule.provider || rule.provider === 'apiKey') {\n            // public with no provider means apiKey\n            authModes.add(GRAPHQL_AUTH_MODE.API_KEY);\n          }\n          break;\n        }\n      default:\n        break;\n    }\n  });\n  return Array.from(authModes);\n}\nexport var multiAuthStrategy = function (_a) {\n  var schema = _a.schema,\n    modelName = _a.modelName;\n  return __awaiter(void 0, void 0, void 0, function () {\n    var currentUser, e_1, attributes, authAttribute, sortedRules;\n    return __generator(this, function (_b) {\n      switch (_b.label) {\n        case 0:\n          _b.trys.push([0, 2,, 3]);\n          return [4 /*yield*/, Auth.currentAuthenticatedUser()];\n        case 1:\n          currentUser = _b.sent();\n          return [3 /*break*/, 3];\n        case 2:\n          e_1 = _b.sent();\n          return [3 /*break*/, 3];\n        case 3:\n          attributes = schema.namespaces.user.models[modelName].attributes;\n          if (attributes) {\n            authAttribute = attributes.find(function (attr) {\n              return attr.type === 'auth';\n            });\n            if (authAttribute.properties && authAttribute.properties.rules) {\n              sortedRules = sortAuthRulesWithPriority(authAttribute.properties.rules);\n              return [2 /*return*/, getAuthRules({\n                currentUser: currentUser,\n                rules: sortedRules\n              })];\n            }\n          }\n          return [2 /*return*/, []];\n      }\n    });\n  });\n};","map":{"version":3,"names":["Auth","GRAPHQL_AUTH_MODE","ModelAttributeAuthProvider","getProviderFromRule","rule","allow","provider","USER_POOLS","API_KEY","sortAuthRulesWithPriority","rules","allowSortPriority","providerSortPriority","__spread","sort","a","b","indexOf","getAuthRules","_a","currentUser","authModes","Set","forEach","add","AMAZON_COGNITO_USER_POOLS","OPENID_CONNECT","AWS_IAM","Array","from","multiAuthStrategy","schema","modelName","currentAuthenticatedUser","_b","sent","attributes","namespaces","user","models","authAttribute","find","attr","type","properties","sortedRules"],"sources":["../../src/authModeStrategies/multiAuthStrategy.ts"],"sourcesContent":[null],"mappings":"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","ignoreList":[]},"metadata":{},"sourceType":"module"}